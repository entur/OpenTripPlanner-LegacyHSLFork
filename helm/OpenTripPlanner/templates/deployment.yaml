apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    {{- include "common.labels" . | indent 4 }}
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  progressDeadlineSeconds: 600
  replicas: {{ .Values.minReplicas }}
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      name: {{ .Release.Name }}
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: {{ .Release.Name }}
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: name
                      operator: In
                      values:
                        - otp
                topologyKey: kubernetes.io/hostname
              weight: 100
      containers:
        - command:
            - /docker-entrypoint.sh
            - java
            - -Dfile.encoding=UTF-8
            - -Dtransmodel.graphql.api.agency.id=RB
            - -Xms{{ .Values.resources.xms }}
            - -Xmx{{ .Values.resources.xmx }}
            - -server
            - -Dcom.sun.management.jmxremote
            - -Dcom.sun.management.jmxremote.port=9010
            - -Dcom.sun.management.jmxremote.local.only=false
            - -Dcom.sun.management.jmxremote.authenticate=false
            - -Dcom.sun.management.jmxremote.ssl=false
            - -javaagent:/opt/agent-bond/agent-bond.jar=jolokia{{`{{host=0.0.0.0}}`}},jmx_exporter{{`{{9779:/opt/agent-bond/jmx_exporter_config.yml}}`}}
            - -jar
            - otp-shaded.jar
            - --server
            - --graphs
            - /code/otpdata
            - --router
            - norway
          env:
            - name: TZ
              value: Europe/Oslo
            - name: MARDUK_GCP_BASE
              value: {{ .Values.mardukBase }}
            - name: ROUTER_CONFIG
              value: router-config.json
          image: {{ .Values.image }}:{{ .Values.imageTag }}
          imagePullPolicy: {{ .Values.imagePullPolicy }}
          lifecycle:
            preStop:
              exec:
                command:
                  - sleep
                  - '10'
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /otp/routers/ready
              port: {{ .Values.service.internalPort }}
              scheme: HTTP
            initialDelaySeconds: 900
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 30
          name: {{ .Release.Name }}
          ports:
            - containerPort: {{ .Values.service.internalPort }}
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /otp/routers/ready
              port: {{ .Values.service.internalPort }}
              scheme: HTTP
            initialDelaySeconds: 120
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 20
          resources:
            limits:
              cpu: {{ .Values.resources.cpuLimit }}
              memory: {{ .Values.resources.memLimit }}
            requests:
              cpu: {{ .Values.resources.cpuRequest }}
              memory: {{ .Values.resources.memRequest }}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /etc/marduk/
              name: marduk-key
            - mountPath: /code/otpdata/norway/router-config.json
              name: config-volume
              subPath: router-config.json
      dnsPolicy: ClusterFirst
      imagePullSecrets:
        - name: rutebanken-registry-key
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 31
      volumes:
        - name: marduk-key
          secret:
            defaultMode: 420
            secretName: {{ .Values.mardukKey }}
        - configMap:
            defaultMode: 420
            name: otp-router-config
          name: config-volume
